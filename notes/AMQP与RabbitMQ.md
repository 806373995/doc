# AMQP与RabbitMQ

## AMQP与MQTT对比

**消息队列遥测传输协议**（MQTT : Message Queuing Telemetry Transport）

协议特点：

- 采用发布/订阅模型，MQTT客户端需要通过消息代理（MQTT Broker）来进行消息的发布和订阅。
- 消息极简，最短消息为两个字节。
- 兼容性非常好，支持多平台。

应用场景：

​	适用于低带宽、不可靠的网络下提供基于云平台的远程设备的数据传输和监控。MQTT协议一般适用于设备数据采集到端，不适用设备与设备之间通信，设备控制能力弱，另外**实时性较差**，一般都在秒级。一般可应用与**嵌入式系统**中。

**高级消息队列协议**（AMQP：Advanced Message Queuing Protocol）

协议特点：

- 和MQTT相同也是采用发布/订阅模型。消息代理Broker的交换机组件（Exchange）会把接收到的消息，根据消息的主题，分配到不同的队列中，以便订阅者接收。
- 它支持不同的确认、事务、用例以及整个消息队列。可靠性高于MQTT
- 最小消息为8个字节，头部消息具有可协商

应用场景：

  凭借其安全性和可靠性级别，它最常用于需要基于服务器的分析环境的环境中，例如**银行业**。在物联网应用中，主要适用于**移动手持设备**与后台数据中心的通信和分析。



两种协议详细区别可参照：https://www.educba.com/amqp-vs-mqtt/

## RabbitMQ结构

基本架构图

![1552936-20201024103921637-693350551](.\image\1552936-20201024103921637-693350551.png)

![1552936-20201023201155073-514621912](.\image\1552936-20201023201155073-514621912.png)

基础组件解释

- Broker : 标识消息队列服务器实体*rabbitmq-server*

- v-host : `Virtual Host `虚拟主机。标识一批交换机、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个vhost本质上就是一个mini版的RabbitMQ服务器，拥有自己的队列、交换器、绑定和权限机制。vhost是AMQP概念的基础，必须在链接时指定，RabbitMQ默认的vhost是 /。

- Exchange: 交换器用来接收生产者发送的消息并将这些消息路由给服务器中的队列。

- Queue : 消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。

- Banding : 绑定，用于消息队列和交换机之间的关联。一个绑定就是基于路由键将交换机和消息队列连接起来的路由规则，所以可以将交换器理解成一个由绑定构成的路由表。

- Channel : 信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内地虚拟链接，AMQP命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说，建立和销毁TCP都是非常昂贵的开销，所以引入了信道的概念，以复用一条TCP连接。

- Connection : 网络连接，比如一个TCP连接。

## Exchange组件

从Exchange概念了解到，Exchange的作用是用于将消息分发到Queue中，在Rabbitmq中提供了多种类型的Exchange，那么他的类型有下面几种：

- direct（直连交换机）：将队列绑定到交换机，消息的 routeKey 需要与队列绑定的 routeKey 相同。
- fanout （扇形交换机）：不处理 routeKey ，直接把消息转发到与其绑定的所有队列中。
- topic（主题交换机）：根据一定的规则，根据 routeKey 把消息转发到符合规则的队列中，其中 # 用于匹配符合一个或者多个词（范围更广）， * 用于匹配一个词。
- headers （头部交换机）：根据消息的 headers 转发消息而不是根据 routeKey 来转发消息, 其中 header 是一个 Map，也就意味着不仅可以匹配字符串类型，也可以匹配其他类型数据。 规则可以分为所有键值对匹配或者单一键值对匹配。

## 七种工作模式

### 1. 简单工作队列

![python-one](.\image\python-one.png)

采用的Exchange为默认交换机

特点：一般用于一对一简单使用。

### 2. 工作队列

![python-two](.\image\python-two.png)

采用的Exchange为默认交换机

特点：绑定单个队列，多个消费者竞争消费，加快消费速度。

### 3. 发布订阅



![python-two](.\image\python-three.png)

采用的Exchange为fanout扇形交换机

特点：一条消息分发到订阅的消息队列，未订阅无法接收到。

### 4. 路由

![python-four](C:\Users\Administrator\OneDrive\笔记\image\python-four.png)

采用的Exchange为direct直连交换机

特点：消息通过routeKey匹配不同的消息队列，到达发送到不同消息队列中的目的。

### 5. 主题

![python-five](.\image\python-five.png)

采用的Exchange为topic主题交换机

特点：通过routeKey的部分匹配，可以使用通配符来判别消息发送到何处。

### 6.远程调用

![python-six](.\image\python-six.png)

采用的Exchange为direct直连交换机

特点：采用双队列，消费者收到消息后，通过一个全新的队列返回数据。

### 7.头部匹配

采用的Exchange为headers 头部交换机

特点：通过头部数据匹配队列。



详细可产看官网：https://www.rabbitmq.com/getstarted.html

## 实际应用场景

在我们项目中应用场景为：

多个设备需要连接到服务端，服务端需要能够知道设备已经连接到服务器，并且服务端能够通过设备号，给设备发送命令。

目的是服务端发送消息到设备，所以服务端相当于作为生产者，而设备端相当于作为消费者。

所以我们采用了路由模式，将不同的设备号作为消息队列的名称，然后再通过路由模式，服务器有消息会将消息分发到指定设备的消息队列。