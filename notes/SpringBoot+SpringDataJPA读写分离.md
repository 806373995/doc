- # SpringBoot + Spring Data JPA 读写分离

- ## 前言

  目前我们项目都使用k8s容器编排来部署项目，由于之前我们的数据库和项目都放到同一个环境（pod）下，现在我们在k8s搭建了一个通用的主从数据库，所以我们需要将数据库切换到通用的主从数据。目前按照一般的配置是**主数据库为读写**，**从数据库为读**的方式来配置。

  

  对于数据库的配置，暂不在本文中介绍，本文主要介绍项目的读写分录。目前我们使用的是mysql数据库，服务器会暴露主从数据库的连接，我们的项目可以通过两个连接来进行数据库的操作。

  

- ## 为什么要使用读写分离

  在数据库访问并发比较高的时候，能够减轻数据库访问的压力，但是前提是必须保持主从数据库的数据一致性。

- ## 方案选取

  根据网上查的一些资料，目前主要的方案有三种：

  1.  使用**动态路由的方式**，根据当前的数据库操作，在 **sql 执行前**判断**切换主从数据源**。具体使用了Spring 的 **AbstractRoutingDataSource** 抽象类，集成该类，来实现读写分离。
  2. 使用**多操作类**的方式，举例对于Spring data jpa 来说就是构建 repository 和entity需要对应一个数据源，所以对于主从分离来说就是两个数据源，所以要对应两套repository和entity。
  3. 使用**中间件**的方式，中间件具有解析sql，动态路由。对于项目来说，将选择数据源交由中间件来执行。

  

  我选择了第1种方案来做，

  对比于第2种方案，需要构建更多的repository和entity，这样对于项目的修改会很大，所以我排除了第2种方案。

  对比于第3种方案，第3种方案需要开启第3方服务来运行，如果使用这种方案的话我们还需要维护这个第3方服务，增加了我们的维护工作。

  所以我们最后选择了第1种方案来做。